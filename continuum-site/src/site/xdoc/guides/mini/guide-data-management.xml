<document>
  <properties>
    <title>Continuum :: Data Management</title>
    <author email="olamy@apache.org">Olivier Lamy</author>
  </properties>
  <body>
    <section name="Data Management">
      <subsection name="Goal">
        <p>When upgrading continuum, it could have some database model changes.  This tool exports data from old database model and imports the data into the new database model.</p>
        <p>There are 2 databases that need to be converted, one for the builds and one for the users.</p>
      </subsection>
      <subsection name="Download The Tool">
      	<p>The tool is a standalone jar that you can download from the central repo.</p>
      	<p>You will need to download 2 versions of the tool, one for the export out of the old version and one for the import into the new version:</p>
      	<ul>
      	  <li><a href="http://repo1.maven.org/maven2/org/apache/maven/continuum/data-management-cli/1.1-beta-2/data-management-cli-1.1-beta-2-app.jar">http://repo1.maven.org/maven2/org/apache/maven/continuum/data-management-cli/1.1-beta-2/data-management-cli-1.1-beta-2-app.jar</a></li>
      	  <li><a href="http://repo1.maven.org/maven2/org/apache/maven/continuum/data-management-cli/1.1-beta-3/data-management-cli-1.1-beta-3-app.jar">http://repo1.maven.org/maven2/org/apache/maven/continuum/data-management-cli/1.1-beta-3/data-management-cli-1.1-beta-3-app.jar</a></li>
      	</ul>
      </subsection>
      <subsection name="Exporting Data from the old version">
        <p>Follow these steps:</p>
        <ul>
          <li>stop the old version of continuum</li>
          <li>export the build and user data from the old version using the jar for the old version:
          <source>
            java -Xmx512m -jar data-management-cli-1.1-beta-2-app.jar -buildsJdbcUrl jdbc:derby:${old.continuum.home}/data/continuum/database -mode EXPORT -file backups/builds
            java -Xmx512m -jar data-management-cli-1.1-beta-2-app.jar -usersJdbcUrl jdbc:derby:${old.continuum.home}/data/users/database -mode EXPORT -file backups/users
          </source>
          </li>
        </ul>
      </subsection>
      <subsection name="Importing Data to the new version">
        <p>Follow these steps:</p>
        <ul>
          <li>start the new version continuum to create the new data model.</li>
          <li>stop continuum</li>
          <li>import the build and user data into the new version using the jar for the new version:
            <source>
              java -Xmx512m -jar data-management-cli-1.1-beta-3-app.jar -buildsJdbcUrl jdbc:derby:${new.continuum.home}/data/continuum/database -mode IMPORT backups/builds
              java -Xmx512m -jar data-management-cli-1.1-beta-3-app.jar -usersJdbcUrl jdbc:derby:${new.continuum.home}/data/users/database -mode IMPORT -f backups/users
            </source>
          </li>
          <li><b>NEXT_VAL values in SEQUENCE_TABLE must be checked before restarting continuum</b>
            <ul>
              <li>Normally, the SEQUENCE_TABLE is ok but in some cases the values are wrong.</li>
              <li>Before starting Continuum for the first time after the import, connect to the db with a client like <a href="http://squirrel-sql.sourceforge.net/">Squirrel SQL</a> and check the values in the NEXT_VAL column.</li>
              <li>Values must be greater than the max id value in each table.</li>
              <li>For example, the next value of "org.apache.maven.continuum.model.Project" must be greater than the greatest id in Project table.</li>
            </ul>
          </li>
          <li>start the new version of continuum.</li>
        </ul>
      </subsection>
    </section>
  </body>
</document>
